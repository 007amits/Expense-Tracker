<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Finance Tracker - User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css(v=${#dates.createNow().getTime()})}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- User Profile Card -->
    <div class="card my-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>User Profile</h3>
            <div>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="bi bi-pencil-square"></i> Edit Profile
                </button>
                <a href="/change-password" class="btn btn-secondary ms-2">
                    <i class="bi bi-key"></i> Change Password
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Personal Information -->
                <div class="col-md-6">
                    <h4 class="mb-3">Personal Information</h4>
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <th style="width: 40%">Username</th>
                                <td th:text="${user.username}"></td>
                            </tr>
                            <tr>
                                <th>Full Name</th>
                                <td th:text="${user.firstName + ' ' + user.lastName}"></td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td th:text="${user.email}"></td>
                            </tr>
                            <tr>
                                <th>Phone Number</th>
                                <td th:text="${user.phoneNumber}"></td>
                            </tr>
                            <tr>
                                <th>Date of Birth</th>
                                <td th:text="${#temporals.format(user.dateOfBirth, 'dd-MM-yyyy')}"></td>
                            </tr>
                            <tr>
                                <th>Gender</th>
                                <td th:text="${user.gender}"></td>
                            </tr>
                            <tr>
                                <th>Occupation</th>
                                <td th:text="${user.occupation}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Account Summary -->
                <div class="col-md-6">
                    <h4 class="mb-3">Account Summary</h4>
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <th style="width: 40%">Total Accounts</th>
                                <td th:text="${accountSummary.totalAccounts}"></td>
                            </tr>
                            <tr>
                                <th>Total Balance</th>
                                <td>
                                    <span th:class="${'fw-bold ' + 
                                        (accountSummary.balanceStatus == 'positive' ? 'text-success' : 
                                         accountSummary.balanceStatus == 'negative' ? 'text-danger' : 'text-info')}" 
                                          th:text="${accountSummary.totalBalance}"></span>
                                </td>
                            </tr>
                            <tr>
                                <th>Total Expenses</th>
                                <td th:text="${accountSummary.totalExpenses}"></td>
                            </tr>
                            <tr>
                                <th>Total Income</th>
                                <td th:text="${accountSummary.totalIncome}"></td>
                            </tr>
                            <tr>
                                <th>Member Since</th>
                                <td th:text="${user.createdAt != null ? #temporals.format(user.createdAt, 'dd-MM-yyyy') : 'N/A'}"></td>
                            </tr>
                        </tbody>
                    </table>
                    <a href="/accounts" class="btn btn-primary mt-2">
                        <i class="bi bi-wallet2"></i> Manage Accounts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" th:action="@{/profile/update}" method="post" th:object="${user}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" th:value="${user.firstName}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" th:value="${user.lastName}" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:value="${user.email}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" th:value="${user.phoneNumber}" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" th:value="${user.dateOfBirth}">
                            <div id="dob-error" class="text-danger small mt-1"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">Select...</option>
                                <option value="Male" th:selected="${user.gender == 'Male'}">Male</option>
                                <option value="Female" th:selected="${user.gender == 'Female'}">Female</option>
                                <option value="Other" th:selected="${user.gender == 'Other'}">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="occupation" class="form-label">Occupation</label>
                        <input type="text" class="form-control" id="occupation" name="occupation" th:value="${user.occupation}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Set max date to today for date of birth
        const today = new Date().toISOString().split('T')[0];
        $('#dateOfBirth').attr('max', today);
        
        // Function to validate date of birth is not in the future
        function validateDateOfBirth() {
            const dateOfBirth = $('#dateOfBirth').val();
            if (!dateOfBirth) return true; // Empty date is valid
            
            // Parse dates and normalize them for comparison
            const selectedDate = new Date(dateOfBirth + 'T00:00:00'); // Ensure consistent time part
            selectedDate.setHours(0, 0, 0, 0);
            
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); // Reset time part for date comparison
            
            // Compare dates using timestamps to avoid timezone issues
            if (selectedDate.getTime() > currentDate.getTime()) {
                $('#dob-error').text("Date of birth cannot be in the future.");
                return false;
            } else {
                $('#dob-error').text("");
                return true;
            }
        }
        
        // Add event listener to validate date when it changes
        $('#dateOfBirth').on('change', validateDateOfBirth);
        
        // Validate form on submit
        $('#editProfileForm').on('submit', function(event) {
            // Validate date of birth
            const validDob = validateDateOfBirth();
            if (!validDob) {
                event.preventDefault(); // Prevent form submission
                $('#dateOfBirth').focus();
            }
        });
    });
</script>
</body>
</html>
